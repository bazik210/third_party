////////////////////////////////////////////////////////////////////////////
//	Created		: 05.12.2010
//	Author		: Nikolay Partas
//	Copyright (C) GSC Game World - 2010
////////////////////////////////////////////////////////////////////////////

#include "common.h"

Texture2D t_distortion;

#define USE_DISPERSION 0

uniform float4 screen_res;

float4 main( v2p_TL vin) : SV_TARGET
{
	float2 screen_uv				= vin.Tex0;
	float4 packed_distortion 		= t_distortion.Sample(s_accumulator, screen_uv);
	
	float2 tc_offset 				= unpack_distortion(packed_distortion);
	
	float distortion_mask 			= saturate(t_distortion.Sample(s_accumulator, screen_uv + tc_offset).z);
	
#if USE_DISPERSION
	float2 distortion_offset		= tc_offset * distortion_mask;
	float4 final_color				= float4(
		t_base.Sample(s_accumulator, screen_uv + 2.0f * distortion_offset).r,
		t_base.Sample(s_accumulator, screen_uv + 3.0f * distortion_offset).g,
		t_base.Sample(s_accumulator, screen_uv + 1.0f * distortion_offset).b,
		1.0f
	);
#else	
	float2 distortion_offset		= tc_offset * distortion_mask;
	float4 final_color				= t_base.Sample(s_accumulator, screen_uv + distortion_offset);
#endif // #if USE_DISPERSION	
	
	return final_color;
}
